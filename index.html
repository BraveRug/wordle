<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Letter Frequency</title>
  <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&display=swap" rel="stylesheet">
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    /* =========================================
       CSS VARIABLES & THEME ENGINE
       ========================================= */
    :root {
      /* Base Defaults (Light) */
      --bg: #ffffff;
      --text: #111111;
      --accent: #0077cc;
      --input-bg: #f0f0f0;
      --card-bg: #ffffff;
      --settings-icon-bg: rgba(128, 128, 128, 0.2);
      --btn-text: white;
      
      /* Static Colors */
      --grey-box: #787c7e;
      --yellow-box: #c9b458;
      --green-box: #6aaa64;
      --delete-red: #e63946;
    }

    /* --- LIGHT THEMES --- */
    body.light          { /* default vars apply */ }
    body.solarized      { --bg: #fdf6e3; --text: #657b83; --accent: #268bd2; --input-bg: #eee8d5; --card-bg: #fdf6e3; }
    body.cherry         { --bg: #fff0f0; --text: #5a0000; --accent: #d32f2f; --input-bg: #ffebee; --card-bg: #ffcdd2; }
    body.peach          { --bg: #fff3e0; --text: #5d4037; --accent: #ff7043; --input-bg: #ffe0b2; --card-bg: #ffccbc; }
    body.sunshine       { --bg: #fffde7; --text: #5d4037; --accent: #fbc02d; --input-bg: #fff9c4; --card-bg: #fff59d; --btn-text: #333; }
    body.forest         { --bg: #e8f5e9; --text: #1b5e20; --accent: #43a047; --input-bg: #c8e6c9; --card-bg: #a5d6a7; }
    body.ocean          { --bg: #e0f7fa; --text: #006064; --accent: #00bcd4; --input-bg: #b2ebf2; --card-bg: #80deea; }
    body.azure          { --bg: #e3f2fd; --text: #0d47a1; --accent: #42a5f5; --input-bg: #bbdefb; --card-bg: #90caf9; }
    body.bluelight      { --bg: #f0f8ff; --text: #002171; --accent: #2962ff; --input-bg: #e1f5fe; --card-bg: #b3e5fc; }
    body.violetlight    { --bg: #ede7f6; --text: #311b92; --accent: #7e57c2; --input-bg: #d1c4e9; --card-bg: #b39ddb; }
    body.plum           { --bg: #f3e5f5; --text: #4a148c; --accent: #ab47bc; --input-bg: #e1bee7; --card-bg: #ce93d8; }
    body.reddishpurple  { --bg: #fce4ec; --text: #880e4f; --accent: #ec407a; --input-bg: #f8bbd0; --card-bg: #f48fb1; }
    body.blush          { --bg: #fff0f5; --text: #880e4f; --accent: #ff4081; --input-bg: #fce4ec; --card-bg: #f8bbd0; }
    body.rose           { --bg: #fae3f4; --text: #4a0072; --accent: #d500f9; --input-bg: #f3e5f5; --card-bg: #e1bee7; }
    body.brownlight     { --bg: #efebe9; --text: #3e2723; --accent: #8d6e63; --input-bg: #d7ccc8; --card-bg: #bcaaa4; }
    body.greyscale      { --bg: #f5f5f5; --text: #212121; --accent: #757575; --input-bg: #e0e0e0; --card-bg: #eeeeee; }

    /* --- ASH THEMES (Mid-Tone) --- */
    body.ash       { --bg: #454955; --text: #F3F5F7; --accent: #AAB7B8; --input-bg: #373b44; --card-bg: #555b69; --settings-icon-bg: rgba(255,255,255,0.1); }
    body.ashblue   { --bg: #374151; --text: #e2e8f0; --accent: #64748b; --input-bg: #1f2937; --card-bg: #475569; --settings-icon-bg: rgba(255,255,255,0.1); }
    body.ashred    { --bg: #4a4040; --text: #ebdada; --accent: #b08d8d; --input-bg: #382e2e; --card-bg: #5e5050; --settings-icon-bg: rgba(255,255,255,0.1); }
    body.ashgreen  { --bg: #404a42; --text: #daebe0; --accent: #8db096; --input-bg: #2e3830; --card-bg: #526155; --settings-icon-bg: rgba(255,255,255,0.1); }
    body.ashpurple { --bg: #45404a; --text: #e8daeb; --accent: #a58db0; --input-bg: #342e38; --card-bg: #595061; --settings-icon-bg: rgba(255,255,255,0.1); }
    body.ashorange { --bg: #4a4540; --text: #ebe3da; --accent: #b09e8d; --input-bg: #38322e; --card-bg: #615950; --settings-icon-bg: rgba(255,255,255,0.1); }

    /* --- DARK THEMES --- */
    body.dark        { --bg: #121212; --text: #e0e0e0; --accent: #4a90e2; --input-bg: #2a2a2a; --card-bg: #1e1e1e; }
    body.midnight    { --bg: #0d1b2a; --text: #e0e1dd; --accent: #415a77; --input-bg: #1b263b; --card-bg: #1e2a3a; }
    body.reddark     { --bg: #1a0f0f; --text: #ffdad4; --accent: #e57373; --input-bg: #2d1a1a; --card-bg: #3b2020; }
    body.orangedark  { --bg: #1a140f; --text: #ffe0b2; --accent: #ffb74d; --input-bg: #332414; --card-bg: #402d18; --btn-text: #333; }
    body.yellowdark  { --bg: #1a180b; --text: #fff9c4; --accent: #ffd54f; --input-bg: #333114; --card-bg: #424017; --btn-text: #333; }
    body.greendark   { --bg: #0e1b0e; --text: #c8e6c9; --accent: #81c784; --input-bg: #1b331b; --card-bg: #224022; --btn-text: #333; }
    body.cyandark    { --bg: #0b1a1a; --text: #b2ebf2; --accent: #4dd0e1; --input-bg: #143333; --card-bg: #194040; --btn-text: #333; }
    body.azuredark   { --bg: #0d1626; --text: #bbdefb; --accent: #64b5f6; --input-bg: #172640; --card-bg: #1e3357; --btn-text: #333; }
    body.deepsea     { --bg: #0a141c; --text: #b3e5fc; --accent: #4fc3f7; --input-bg: #122533; --card-bg: #172f40; --btn-text: #333; }
    body.violetnight { --bg: #12101c; --text: #d1c4e9; --accent: #9575cd; --input-bg: #221e33; --card-bg: #2c2742; }
    body.purpledark  { --bg: #140d1c; --text: #e1bee7; --accent: #ba68c8; --input-bg: #261933; --card-bg: #322142; }
    body.merlot      { --bg: #1a0d14; --text: #f8bbd0; --accent: #f06292; --input-bg: #331926; --card-bg: #422031; }
    body.browndark   { --bg: #1a120f; --text: #d7ccc8; --accent: #a1887f; --input-bg: #33241d; --card-bg: #422e25; }
    body.charcoal    { --bg: #181818; --text: #e0e0e0; --accent: #9e9e9e; --input-bg: #2e2e2e; --card-bg: #383838; --btn-text: #111; }

    /* --- ONYX THEMES (Pure Black) --- */
    body.onyx       { --bg: #000000; --text: #ffffff; --accent: #ffffff; --input-bg: #111111; --card-bg: #0a0a0a; --settings-icon-bg: rgba(50,50,50,0.5); --btn-text: #000; }
    body.onyxred    { --bg: #000000; --text: #fff; --accent: #ff003c; --input-bg: #111; --card-bg: #0d0d0d; }
    body.onyxblue   { --bg: #000000; --text: #fff; --accent: #00e5ff; --input-bg: #111; --card-bg: #0d0d0d; --btn-text: #000; }
    body.onyxgreen  { --bg: #000000; --text: #fff; --accent: #00ff41; --input-bg: #111; --card-bg: #0d0d0d; --btn-text: #000; }
    body.onyxpurple { --bg: #000000; --text: #fff; --accent: #bf00ff; --input-bg: #111; --card-bg: #0d0d0d; }
    body.onyxorange { --bg: #000000; --text: #fff; --accent: #ff8c00; --input-bg: #111; --card-bg: #0d0d0d; --btn-text: #000; }

    /* =========================================
       GLOBAL STYLES
       ========================================= */
    * { box-sizing: border-box; font-family: 'Didact Gothic', sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    body { margin:0; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; padding:20px; min-height:100vh; }
    
    /* Layout & Utilities */
    .app-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; position: relative; margin-bottom: 20px; min-height: 40px; }
    .app-header h2 { position: absolute; left: 50%; transform: translateX(-50%); margin: 0; white-space: nowrap; font-size: clamp(1rem, 5vw, 1.4rem); }
    
    /* Header Buttons */
    .header-btn { background: var(--settings-icon-bg); border: none; font-size: 1.5em; cursor: pointer; color: var(--text); border-radius: 50%; padding: 8px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; transition: background-color 0.3s; }
    .header-btn:hover { background: var(--accent); color: white; }
    #searchBtn { position: absolute; left: 0; }
    #settingsIconBtn { position: absolute; right: 0; top: 50%; transform: translateY(-50%); }

    /* Main Containers */
    .main-content-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: flex-start; }
    .container { background:var(--card-bg); padding:25px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.15); width:100%; }
    
    /* Input Areas */
    .content-area { display: flex; width: 100%; flex-direction: row; justify-content: space-between; gap: 20px; }
    .result-box { background:var(--input-bg); padding:16px; border-radius:10px; font-family:'Courier New', monospace; white-space:pre-wrap; font-size:1em; color:var(--text); flex-basis: calc(50% - 10px); align-self: stretch; }
    
    /* Content Editable Replaces Textarea/Input */
    #wordInputTextarea, #wordInputText {
        padding: 12px; font-size: 1em; border: 1px solid var(--input-bg); border-radius: 8px; 
        background: var(--input-bg); color: var(--text); 
        white-space: pre-wrap; word-wrap: break-word; font-family: 'Didact Gothic', sans-serif;
        outline: none;
        overflow-y: auto;
    }
    #wordInputTextarea { flex-basis: calc(50% - 10px); min-height: 50px; resize: none; }
    #wordInputText { width: 100%; margin-bottom: 10px; display:none; min-height: 46px; }
    
    /* Placeholder Logic */
    #wordInputText:empty:before, #wordInputTextarea:empty:before {
        content: attr(placeholder);
        color: #888;
        pointer-events: none;
        display: block;
    }

    /* Strikethrough Styling - STRICT */
    .struck {
        text-decoration: line-through;
        background-color: rgba(255, 0, 0, 0.15) !important;
        text-decoration-color: red !important;
        text-decoration-thickness: 2px !important;
        text-decoration-skip-ink: none;
        border-radius: 3px;
        padding: 0 2px;
        color: var(--text);
    }

    /* Strikethrough Mode Cursors & Interactions */
    body.mode-strikethrough #wordInputText, 
    body.mode-strikethrough #wordInputTextarea {
        cursor: pointer; /* Acts like a button */
        caret-color: transparent; /* Hide text caret */
    }

    /* Layout overrides */
    body.layout-original .content-area { flex-direction: column; gap: 10px; }
    body.layout-original #wordInputText { display: block; }
    body.layout-original #wordInputTextarea { display: none; }
    body.layout-original .result-box { width: 100%; flex-basis: auto; }

    /* Modals */
    .modal { position:fixed; top:0; left:0; right:0; bottom:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); z-index:100; }
    .modal-content { background:var(--card-bg); padding:20px; border-radius:12px; width:90%; max-width:600px; text-align:center; position:relative; max-height:80vh; overflow-y:auto; }
    .close-btn { position:absolute; top:10px; right:15px; background:none; border:none; font-size:1.2em; color:var(--text); cursor:pointer; }
    
    /* Undo Button */
    .undo-btn { 
        position:absolute; top:10px; left:15px; 
        background:none; border:none; 
        width: 30px; height: 30px;
        display: flex; align-items: center; justify-content: center;
        cursor:pointer; padding: 0;
    }
    .undo-btn svg { width: 20px; height: 20px; fill: var(--text); transition: fill 0.2s; }
    .undo-btn:hover svg { fill: var(--accent); }

    /* Settings & Theme Selection */
    .settings-section h3, .modal-content > h3 { margin: 20px 0 10px; font-size: 1.15em; color: var(--text); border-bottom: 1px solid var(--input-bg); padding-bottom: 8px; }
    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    .theme-column h3 { font-size: 1.05em; margin-top: 0; margin-bottom: 10px; border-bottom: 1px dashed var(--input-bg); padding-bottom: 5px; color: var(--text); }
    .theme-option { display:block; width:100%; padding:10px; margin:5px 0; border:none; border-radius:8px; font-size:0.9em; cursor:pointer; color:white; }
    .theme-option.active-theme { border: 2px solid var(--text); box-shadow: 0 0 8px rgba(0,0,0,0.3); font-weight: bold; }

    /* Layout Selection Buttons */
    .layout-option { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; padding: 10px; border-radius: 8px; background-color: var(--input-bg); color: var(--text); width: calc(50% - 10px); transition: background-color 0.2s; }
    .layout-option:hover, .layout-option.active-layout { background-color: var(--accent); color: white; }
    .layout-option.active-layout { border: 2px solid var(--bg); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    .layout-icon { margin-bottom: 5px; height: 35px; width: auto; display: flex; align-items: center; justify-content: center; }
    .layout-icon svg { fill: currentColor; height: 100%; width: auto; }

    /* Theme Button Colors Mappings */
    .light-btn { background:#0077cc; } .solarized-btn { background:#268bd2; } .cherry-btn { background:#d32f2f; } .peach-btn { background:#ff7043; } .sunshine-btn { background:#fbc02d; color:#000; } .forest-btn { background:#43a047; } .ocean-btn { background:#00bcd4; } .azure-btn { background:#42a5f5; } .bluelight-btn { background:#2962ff; } .violetlight-btn { background:#7e57c2; } .plum-btn { background:#ab47bc; } .reddishpurple-btn { background:#ec407a; } .blush-btn { background:#ff4081; } .rose-btn { background:#d500f9; } .brownlight-btn { background:#8d6e63; } .greyscale-btn { background:#757575; }
    .ash-btn { background: #607d8b; } .ashblue-btn { background: #64748b; } .ashred-btn { background: #b08d8d; } .ashgreen-btn { background: #8db096; } .ashpurple-btn { background: #a58db0; } .ashorange-btn { background: #b09e8d; }
    .dark-btn { background:#333; } .midnight-btn { background:#415a77; } .reddark-btn { background:#e57373; } .orangedark-btn { background:#ffb74d; color: #333; } .yellowdark-btn { background:#ffd54f; color: #333; } .greendark-btn { background:#81c784; color: #333; } .cyandark-btn { background:#4dd0e1; color: #333; } .azuredark-btn { background:#64b5f6; color: #333; } .deepsea-btn { background:#4fc3f7; color: #333; } .violetnight-btn { background:#9575cd; } .purpledark-btn { background:#ba68c8; } .merlot-btn { background:#f06292; } .browndark-btn { background:#a1887f; } .charcoal-btn { background:#9e9e9e; color: #111; }
    
    /* Onyx Buttons */
    .onyx-btn { background: #000; border: 1px solid #333; } 
    .onyxred-btn { background: #cc0033; } 
    .onyxblue-btn { background: #00b8cc; color:#000; } 
    .onyxgreen-btn { background: #00cc33; color:#000; } 
    .onyxpurple-btn { background: #9900cc; } 
    .onyxorange-btn { background: #cc7000; color:#000; }

    /* Wordle Grid & Inputs */
    .wordle-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .wordle-row { display: flex; justify-content: center; gap: 10px; }
    .wordle-box { width: 50px; height: 50px; border: 2px solid #565758; background-color: var(--grey-box); color: white; font-size: 1.8em; font-weight: bold; text-align: center; text-transform: uppercase; caret-color: transparent; cursor: pointer; }
    .wordle-box[data-color="yellow"] { background-color: var(--yellow-box); }
    .wordle-box[data-color="green"] { background-color: var(--green-box); }
    
    .palette { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
    .palette-color { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s, border-color 0.2s; }
    .palette-color:hover, .palette-color.active-color { transform: scale(1.15); border-color: var(--accent); }
    .palette-color.grey { background-color: var(--grey-box); }
    .palette-color.yellow { background-color: var(--yellow-box); }
    .palette-color.green { background-color: var(--green-box); }

    /* Buttons & Lists */
    #saveCombinationBtn, .save-data-btn, #confirmBtn, #cancelBtn, .open-btn, .delete-btn, #strikethroughBtn { border: none; border-radius: 8px; padding: 10px 18px; font-size: 1em; cursor: pointer; transition: 0.2s; color: var(--btn-text); background-color: var(--accent); }
    
    .action-row { display: flex; gap: 10px; width: 100%; margin-top: 15px; }
    #saveCombinationBtn { flex-grow: 1; margin-top: 0; }
    #saveCombinationBtn:hover { background-color: var(--text); color: var(--bg); }
    
    #strikethroughBtn { width: 50px; display: flex; align-items: center; justify-content: center; background-color: var(--input-bg); color: var(--text); }
    #strikethroughBtn.active-strike { background-color: var(--delete-red); color: white; }

    #confirmBtn, .delete-btn { background-color: var(--delete-red); color: white; }
    
    .test-word-input { width: 100%; max-width: 290px; margin: 0 auto; display: block; padding: 12px; font-size: 1em; border: 1px solid var(--input-bg); border-radius: 8px; background: var(--input-bg); color: var(--text); }
    .main-page-input { width: 100%; max-width: 100%; margin-top: 20px; }

    #savedCombinationsList { display: flex; flex-direction: column; gap: 15px; max-height: 60vh; overflow-y: auto; padding-right: 10px; }
    .saved-item { border: 1px solid var(--input-bg); border-radius: 8px; padding: 15px; }
    .saved-item .wordle-grid { transform: scale(0.7); margin-bottom: -20px; pointer-events: none; }
    .saved-item-actions { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }

    /* Notifications */
    #message-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .message { padding: 15px 20px; border-radius: 8px; color: white; font-size: 1em; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0.95; }
    .message.success { background-color: #28a745; }
    .message.error { background-color: var(--delete-red); }
    .confirmation-actions { margin-top: 20px; display: flex; justify-content: center; gap: 20px; }
  </style>
</head>
<body class="light">
  <div class="app-header">
    <button id="searchBtn" class="header-btn" onclick="openSearchModal()">üîç</button>
    <h2>Letter Frequency</h2>
    <button id="settingsIconBtn" class="header-btn" onclick="openModal()">‚öôÔ∏è</button>
  </div>
  <div id="message-container"></div>
  <div class="main-content-wrapper">
    <input type="hidden" id="loadedCombinationId">
    <div class="container">
      <div class="content-area">
        <div contenteditable="true" id="wordInputText" placeholder="Type words here..." oninput="handleWordInput()"></div>
        <div contenteditable="true" id="wordInputTextarea" placeholder="Type words here..." oninput="handleWordInput()"></div>
        <div id="result" class="result-box"></div>
      </div>
      <input type="text" id="mainTestWordInput" placeholder="Enter test word here..." class="test-word-input main-page-input">
    </div>
    <div class="action-row">
        <button id="saveCombinationBtn">Save Combination</button>
        <button id="strikethroughBtn" onclick="toggleStrikethroughMode()">‚ùå</button>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
      
      <div class="settings-section">
        <h3>Layout Options</h3>
        <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
          <div id="layout-side-by-side" class="layout-option" onclick="setLayout('side-by-side')">
            <div class="layout-icon"><svg viewBox="0 0 100 60"><rect x="10" y="5" width="35" height="50" rx="3"/><rect x="55" y="5" width="35" height="50" rx="3"/></svg></div>
            <div>Side-by-Side</div>
          </div>
          <div id="layout-original" class="layout-option" onclick="setLayout('original')">
            <div class="layout-icon"><svg viewBox="0 0 100 60"><rect x="10" y="15" width="80" height="30" rx="3"/></svg></div>
            <div>Original</div>
          </div>
        </div>
      </div>

      <h3>Select a Theme</h3>
      <div class="theme-grid">
        <div class="theme-column">
          <h3>Light</h3>
          <button class="theme-option light-btn" onclick="setTheme('light')">Light</button>
          <button class="theme-option solarized-btn" onclick="setTheme('solarized')">Solarized</button>
          <button class="theme-option cherry-btn" onclick="setTheme('cherry')">Cherry</button>
          <button class="theme-option peach-btn" onclick="setTheme('peach')">Peach</button>
          <button class="theme-option sunshine-btn" onclick="setTheme('sunshine')">Sunshine</button>
          <button class="theme-option forest-btn" onclick="setTheme('forest')">Forest</button>
          <button class="theme-option ocean-btn" onclick="setTheme('ocean')">Ocean</button>
          <button class="theme-option azure-btn" onclick="setTheme('azure')">Azure</button>
          <button class="theme-option bluelight-btn" onclick="setTheme('bluelight')">Blue Light</button>
          <button class="theme-option violetlight-btn" onclick="setTheme('violetlight')">Violet Light</button>
          <button class="theme-option plum-btn" onclick="setTheme('plum')">Plum</button>
          <button class="theme-option reddishpurple-btn" onclick="setTheme('reddishpurple')">Reddish Purple</button>
          <button class="theme-option blush-btn" onclick="setTheme('blush')">Blush</button>
          <button class="theme-option rose-btn" onclick="setTheme('rose')">Rose</button>
          <button class="theme-option brownlight-btn" onclick="setTheme('brownlight')">Brown Light</button>
          <button class="theme-option greyscale-btn" onclick="setTheme('greyscale')">Greyscale</button>
        </div>
        <div class="theme-column">
          <h3>Ash</h3>
          <button class="theme-option ash-btn" onclick="setTheme('ash')">Ash</button>
          <button class="theme-option ashblue-btn" onclick="setTheme('ashblue')">Ash Blue</button>
          <button class="theme-option ashred-btn" onclick="setTheme('ashred')">Ash Red</button>
          <button class="theme-option ashgreen-btn" onclick="setTheme('ashgreen')">Ash Green</button>
          <button class="theme-option ashpurple-btn" onclick="setTheme('ashpurple')">Ash Purple</button>
          <button class="theme-option ashorange-btn" onclick="setTheme('ashorange')">Ash Orange</button>
        </div>
      </div>
      <div class="theme-grid" style="margin-top: 20px;">
        <div class="theme-column">
          <h3>Dark</h3>
          <button class="theme-option dark-btn" onclick="setTheme('dark')">Dark</button>
          <button class="theme-option midnight-btn" onclick="setTheme('midnight')">Midnight</button>
          <button class="theme-option reddark-btn" onclick="setTheme('reddark')">Red Dark</button>
          <button class="theme-option orangedark-btn" onclick="setTheme('orangedark')">Orange Dark</button>
          <button class="theme-option yellowdark-btn" onclick="setTheme('yellowdark')">Yellow Dark</button>
          <button class="theme-option greendark-btn" onclick="setTheme('greendark')">Green Dark</button>
          <button class="theme-option cyandark-btn" onclick="setTheme('cyandark')">Cyan Dark</button>
          <button class="theme-option azuredark-btn" onclick="setTheme('azuredark')">Azure Dark</button>
          <button class="theme-option deepsea-btn" onclick="setTheme('deepsea')">Deep Sea</button>
          <button class="theme-option violetnight-btn" onclick="setTheme('violetnight')">Violet Night</button>
          <button class="theme-option purpledark-btn" onclick="setTheme('purpledark')">Purple Dark</button>
          <button class="theme-option merlot-btn" onclick="setTheme('merlot')">Merlot</button>
          <button class="theme-option browndark-btn" onclick="setTheme('browndark')">Brown Dark</button>
          <button class="theme-option charcoal-btn" onclick="setTheme('charcoal')">Charcoal</button>
        </div>
        <div class="theme-column">
          <h3>Onyx</h3>
          <button class="theme-option onyx-btn" onclick="setTheme('onyx')">Onyx</button>
          <button class="theme-option onyxred-btn" onclick="setTheme('onyxred')">Onyx Red</button>
          <button class="theme-option onyxblue-btn" onclick="setTheme('onyxblue')">Onyx Blue</button>
          <button class="theme-option onyxgreen-btn" onclick="setTheme('onyxgreen')">Onyx Green</button>
          <button class="theme-option onyxpurple-btn" onclick="setTheme('onyxpurple')">Onyx Purple</button>
          <button class="theme-option onyxorange-btn" onclick="setTheme('onyxorange')">Onyx Orange</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="saveCombinationModal">
    <div class="modal-content">
        <button class="undo-btn" onclick="undoWordleGrid()">
            <svg viewBox="0 0 24 24">
                <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
            </svg>
        </button>
        <button class="close-btn" onclick="closeSaveModal()">‚úï</button>
        <input type="hidden" id="combinationId">
        <h3>Save Wordle Combination</h3>
        
        <div class="palette">
            <div class="palette-color grey active-color" data-color="grey"></div>
            <div class="palette-color yellow" data-color="yellow"></div>
            <div class="palette-color green" data-color="green"></div>
        </div>

        <div class="wordle-grid">
            <div class="wordle-row">
                <input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" />
            </div>
            <div class="wordle-row">
                <input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" />
            </div>
        </div>

        <input type="text" id="testWordInput" placeholder="Your test word..." class="test-word-input" style="margin-top:10px; margin-bottom:15px;">
        <button id="saveCombinationDataBtn" class="save-data-btn">Save Combination</button>
    </div>
  </div>

  <div class="modal" id="searchModal">
      <div class="modal-content">
          <button class="undo-btn" onclick="undoWordleGrid()">
             <svg viewBox="0 0 24 24">
                <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
            </svg>
          </button>
          <button class="close-btn" onclick="closeModal('searchModal')">‚úï</button>
          <h3>Search Combinations</h3>
          
          <div class="palette">
              <div class="palette-color grey active-color" data-color="grey"></div>
              <div class="palette-color yellow" data-color="yellow"></div>
              <div class="palette-color green" data-color="green"></div>
          </div>

          <div class="wordle-grid">
              <div class="wordle-row">
                  <input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" />
              </div>
              <div class="wordle-row">
                  <input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" /><input type="text" maxlength="1" class="wordle-box" />
              </div>
          </div>

          <button class="open-btn" style="margin-top: 15px;" onclick="openFirstMatchingCombination()">Open</button>
          <div id="savedCombinationsList" style="display: none;"></div>
      </div>
  </div>

  <div class="modal" id="confirmationModal">
    <div class="modal-content">
        <p id="confirmationMessage">Are you sure?</p>
        <div class="confirmation-actions">
            <button id="confirmBtn">Yes</button>
            <button id="cancelBtn">No</button>
        </div>
    </div>
  </div>

  <script>
    /* =========================================
       STATE MANAGEMENT
       ========================================= */
    let activeInputElement;
    let selectedColor = 'grey';
    let confirmCallback = null;
    let inputDebounceTimer;
    let isStrikethroughMode = false;
    let gridHistory = [];

    /* =========================================
       INITIALIZATION
       ========================================= */
    document.addEventListener('DOMContentLoaded', () => {
        initializePage();
        attachEventListeners();
        countLetters(); // Run immediately on load
    });

    function initializePage() {
        const savedTheme = localStorage.getItem('selectedTheme') || 'light';
        const savedLayout = localStorage.getItem('selectedLayout') || 'side-by-side';
        
        setTheme(savedTheme, false); // false = don't close modal on init
        applyLayout(savedLayout);
    }

    function attachEventListeners() {
        // Debounce main input
        const handleInput = () => {
            // Fix: Check for empty content to restore placeholder
            if (activeInputElement && !activeInputElement.textContent.trim()) {
                activeInputElement.innerHTML = '';
            }
            
            sanitizeFormatting();
            
            clearTimeout(inputDebounceTimer);
            inputDebounceTimer = setTimeout(handleWordInput, 300); // 300ms delay
        };
        document.getElementById('wordInputText').addEventListener('input', handleInput);
        document.getElementById('wordInputTextarea').addEventListener('input', handleInput);
        
        // Enter Key Handler (Fixes Strikethrough Glitch)
        const handleEnterKey = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // Get current selection
                const sel = window.getSelection();
                const range = sel.getRangeAt(0);
                
                // Create a new line break
                const br = document.createElement('br');
                range.deleteContents();
                range.insertNode(br);
                
                // Create a second br if we're at the end to ensure cursor moves down
                const container = br.parentNode;
                if (!br.nextSibling || (br.nextSibling.nodeType === Node.ELEMENT_NODE && br.nextSibling.tagName === 'BR')) {
                    const br2 = document.createElement('br');
                    container.insertBefore(br2, br.nextSibling);
                    range.setStartAfter(br2);
                } else {
                    range.setStartAfter(br);
                }
                
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
                
                // Ensure we're not in a struck span
                let node = range.startContainer;
                if (node.nodeType === Node.ELEMENT_NODE && node.classList && node.classList.contains('struck')) {
                    // Move cursor outside the struck span
                    range.setStartAfter(node);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } else if (node.parentNode && node.parentNode.classList && node.parentNode.classList.contains('struck')) {
                    // If we're inside a struck span, move outside
                    range.setStartAfter(node.parentNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
                
                handleWordInput();
            }
        };
        document.getElementById('wordInputText').addEventListener('keydown', handleEnterKey);
        document.getElementById('wordInputTextarea').addEventListener('keydown', handleEnterKey);

        // Strikethrough Click Handler
        document.getElementById('wordInputText').addEventListener('click', handleEditorClick);
        document.getElementById('wordInputTextarea').addEventListener('click', handleEditorClick);
        
        // Paste plain text only
        const handlePaste = (e) => {
            e.preventDefault();
            const text = (e.originalEvent || e).clipboardData.getData('text/plain');
            document.execCommand("insertText", false, text);
        };
        document.getElementById('wordInputText').addEventListener('paste', handlePaste);
        document.getElementById('wordInputTextarea').addEventListener('paste', handlePaste);

        // Modals
        document.getElementById('settingsModal').addEventListener('click', handleModalOutsideClick);
        document.getElementById('saveCombinationModal').addEventListener('click', handleModalOutsideClick);
        document.getElementById('searchModal').addEventListener('click', handleModalOutsideClick);
        
        // Save Combination
        document.getElementById('saveCombinationBtn').addEventListener('click', openSaveModal);
        document.getElementById('saveCombinationDataBtn').addEventListener('click', saveCombinationData);
        
        // Search / Load
        document.getElementById('savedCombinationsList')?.addEventListener('click', handleSavedListClick);

        // Confirmation
        document.getElementById('confirmBtn').addEventListener('click', () => {
            closeModal('confirmationModal');
            if (confirmCallback) confirmCallback();
        });
        document.getElementById('cancelBtn').addEventListener('click', () => closeModal('confirmationModal'));

        // Palette Delegation (for both modals)
        document.querySelectorAll('.palette').forEach(p => p.addEventListener('click', selectPaletteColor));
        
        // Wordle Grid Delegation (Input handling)
        document.querySelectorAll('.wordle-grid').forEach(grid => {
            // Fix Undo: Capture state on MOUSE DOWN (before click/color change)
            grid.addEventListener('mousedown', (e) => {
                if(e.target.classList.contains('wordle-box') || e.target.classList.contains('palette-color')) {
                    pushHistory();
                }
            });
            grid.addEventListener('click', colorWordleBox);

            // Fix Undo: Capture state on KEY DOWN (before value change)
            grid.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' || /^[a-zA-Z0-9]$/.test(e.key)) {
                    pushHistory();
                }
                handleWordleBoxKeyDown(e);
            });
            
            grid.addEventListener('beforeinput', onBoxBeforeInput);
            grid.addEventListener('input', onBoxInput);
        });
    }

    /* =========================================
       CORE LOGIC
       ========================================= */
    function handleWordInput() {
        if (!activeInputElement) return;
        if (activeInputElement.id === 'wordInputTextarea') updateTextareaHeight(activeInputElement);
        countLetters();
    }

    function sanitizeFormatting() {
        if (!activeInputElement) return;
        const spans = activeInputElement.querySelectorAll('.struck');
        spans.forEach(span => {
            // Only remove empty struck spans that don't have any text at all
            if (span.textContent.trim().length === 0) {
                span.remove();
                return;
            }

            // Handle spaces: If user types space, break the span
            if (/[\s]/.test(span.textContent)) {
                const text = span.textContent;
                const parts = text.split(/(\s+)/); // split by whitespace, keeping it
                
                const fragment = document.createDocumentFragment();
                let lastNode = null;

                parts.forEach(part => {
                    if (!part) return;
                    if (/\s/.test(part)) {
                        // Create text node for space (not struck)
                        lastNode = document.createTextNode(part);
                        fragment.appendChild(lastNode);
                    } else {
                        // Keep word struck - preserve the red styling
                        const s = document.createElement('span');
                        s.className = 'struck';
                        s.textContent = part;
                        fragment.appendChild(s);
                        lastNode = s; 
                    }
                });

                span.replaceWith(fragment);
                
                // Restore cursor after space
                if (lastNode && lastNode.nodeType === Node.TEXT_NODE) {
                    const range = document.createRange();
                    range.setStartAfter(lastNode);
                    range.collapse(true);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        });
    }

    function toggleStrikethroughMode() {
        isStrikethroughMode = !isStrikethroughMode;
        document.getElementById('strikethroughBtn').classList.toggle('active-strike', isStrikethroughMode);
        document.body.classList.toggle('mode-strikethrough', isStrikethroughMode);
        
        // Lock/Unlock editing
        if (activeInputElement) {
            activeInputElement.contentEditable = !isStrikethroughMode;
        }
    }

    function handleEditorClick(e) {
        if (!isStrikethroughMode) return;
        
        let target = e.target;
        
        // Handle clicking on an existing struck word (Unstrike)
        if (target.classList.contains('struck')) {
            const text = target.textContent;
            target.replaceWith(document.createTextNode(text));
            handleWordInput();
            return;
        }
        
        // Handle clicking on a plain word (Strike)
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        let node = range.startContainer;
        let offset = range.startOffset;

        if (node.nodeType === Node.ELEMENT_NODE) return;

        if (node.nodeType === Node.TEXT_NODE) {
             const text = node.textContent;
             // Find start of word
             let start = offset;
             while (start > 0 && /\w/.test(text[start - 1])) start--;
             
             // Find end of word
             let end = offset;
             while (end < text.length && /\w/.test(text[end])) end++;
             
             // Check valid word
             if (start === end) return; 

             const rng = document.createRange();
             rng.setStart(node, start);
             rng.setEnd(node, end);
             
             const span = document.createElement('span');
             span.className = 'struck';
             rng.surroundContents(span);
             
             sel.removeAllRanges(); 
             handleWordInput();
        }
    }

    /* Helper to get clean text with proper newline preservation for word counting */
    function getCleanText(element) {
        if (!element) return "";
        let clone = element.cloneNode(true);
        
        // Remove struck words first
        clone.querySelectorAll('.struck').forEach(el => el.remove());

        // Convert BRs and block elements to newlines for proper word separation
        const brs = clone.querySelectorAll('br');
        brs.forEach(br => {
            const newline = document.createTextNode('\n');
            br.parentNode.replaceChild(newline, br);
        });

        // Convert divs and other block elements to newlines
        const blockElements = clone.querySelectorAll('div, p');
        blockElements.forEach(el => {
            const newline = document.createTextNode('\n');
            el.parentNode.insertBefore(newline, el);
        });

        return clone.textContent || "";
    }

    /* Helper to get text for saving (preserves actual newlines) */
    function getTextForSaving(element) {
        if (!element) return "";
        let clone = element.cloneNode(true);
        
        // Remove struck words
        clone.querySelectorAll('.struck').forEach(el => el.remove());

        // Convert BRs to actual newlines
        const brs = clone.querySelectorAll('br');
        brs.forEach(br => {
            const newline = document.createTextNode('\n');
            br.parentNode.replaceChild(newline, br);
        });

        // Convert divs to newlines (but not the first one if it's the root)
        const divs = clone.querySelectorAll('div');
        divs.forEach((div, index) => {
            if (index > 0 || div.parentNode !== clone) {
                const newline = document.createTextNode('\n');
                if (div.parentNode) {
                    div.parentNode.insertBefore(newline, div);
                }
            }
        });

        return clone.textContent || "";
    }

    function countLetters() {
        if (!activeInputElement) return;
        
        // Use the new clean text extractor that properly handles newlines
        let text = getCleanText(activeInputElement).toLowerCase();
        
        // Extract words - treats newlines and spaces as word boundaries
        // Remove asterisks before word extraction
        text = text.replace(/\*/g, '');
        const words = text.match(/[a-z]+/g) || [];
        
        const letterMap = {};
        
        for (const word of words) {
            const unique = new Set(word.replace(/[^a-z]/g, ''));
            for (const letter of unique) {
                letterMap[letter] = (letterMap[letter] || 0) + 1;
            }
        }
        
        const sorted = Object.entries(letterMap).sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
        const output = sorted.map(([l, c]) => `${l}: ${c}`).join('\n');
        document.getElementById('result').textContent = output || 'No letters found.';
    }

    function updateTextareaHeight(el) {
        el.style.height = 'auto';
        const maxHeight = Math.min(500, window.innerHeight * 0.6);
        el.style.height = (el.scrollHeight > maxHeight ? maxHeight : el.scrollHeight) + 'px';
        el.style.overflowY = el.scrollHeight > maxHeight ? 'auto' : 'hidden';
    }

    /* =========================================
       THEMING & LAYOUT
       ========================================= */
    function setTheme(theme, autoClose = true) {
        const layoutClass = document.body.classList.contains('layout-original') ? 'layout-original' : '';
        const strikeClass = document.body.classList.contains('mode-strikethrough') ? 'mode-strikethrough' : '';
        document.body.className = `${theme} ${layoutClass} ${strikeClass}`;
        localStorage.setItem('selectedTheme', theme);
        
        // Update Active Button UI
        document.querySelectorAll('.theme-option').forEach(btn => {
            const isMatch = btn.textContent.toLowerCase() === theme.replace(/-/g, ' ').toLowerCase() || 
                            btn.getAttribute('onclick').includes(`'${theme}'`);
            btn.classList.toggle('active-theme', isMatch);
        });

        if (autoClose) closeModal('settingsModal');
    }

    function setLayout(layoutName) {
        // Preserve HTML content
        const oldContent = activeInputElement ? activeInputElement.innerHTML : "";
        applyLayout(layoutName);
        if (activeInputElement) {
            activeInputElement.innerHTML = oldContent;
            // Ensure editable state matches current mode
            activeInputElement.contentEditable = !isStrikethroughMode;
            handleWordInput();
        }
        localStorage.setItem('selectedLayout', layoutName);
        closeModal('settingsModal');
    }

    function applyLayout(layout) {
        const textInput = document.getElementById('wordInputText');
        const areaInput = document.getElementById('wordInputTextarea');
        const isOriginal = layout === 'original';

        document.body.classList.toggle('layout-original', isOriginal);
        textInput.style.display = isOriginal ? 'block' : 'none';
        areaInput.style.display = isOriginal ? 'none' : 'block';
        activeInputElement = isOriginal ? textInput : areaInput;

        document.querySelectorAll('.layout-option').forEach(btn => btn.classList.remove('active-layout'));
        document.getElementById(`layout-${layout}`)?.classList.add('active-layout');
    }

    /* =========================================
       MODAL UTILS
       ========================================= */
    function openModal() { document.getElementById('settingsModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function handleModalOutsideClick(e) { if (e.target.classList.contains('modal')) closeModal(e.target.id); }

    function showMessage(msg, type = 'success') {
        const el = document.createElement('div');
        el.className = `message ${type}`;
        el.textContent = msg;
        document.getElementById('message-container').appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    /* =========================================
       WORDLE GRID INTERACTION
       ========================================= */
    function pushHistory() {
        const activeModal = document.querySelector('.modal[style*="display: flex"]');
        if (!activeModal) return;
        const gridData = getGridData('#' + activeModal.id);
        gridHistory.push(JSON.stringify(gridData));
        if (gridHistory.length > 50) gridHistory.shift();
    }

    function undoWordleGrid() {
        if (gridHistory.length === 0) return;
        const lastState = JSON.parse(gridHistory.pop());
        const activeModal = document.querySelector('.modal[style*="display: flex"]');
        if (activeModal) {
            populateGrid('#' + activeModal.id, { rows: lastState });
        }
    }

    function selectPaletteColor(e) {
        if (!e.target.classList.contains('palette-color')) return;
        const palette = e.currentTarget;
        palette.querySelectorAll('.palette-color').forEach(c => c.classList.remove('active-color'));
        e.target.classList.add('active-color');
        selectedColor = e.target.dataset.color;
    }

    function colorWordleBox(e) {
        if (!e.target.classList.contains('wordle-box')) return;
        e.target.dataset.color = selectedColor;
    }

    function handleWordleBoxKeyDown(e) {
        if (!e.target.classList.contains('wordle-box')) return;
        const box = e.target;
        const row = box.parentElement;
        const boxes = Array.from(row.querySelectorAll('.wordle-box'));
        const idx = boxes.indexOf(box);

        if (e.key === 'Backspace') {
            if (box.value) {
                box.value = '';
            } else if (idx > 0) {
                boxes[idx - 1].focus();
            }
        } else if (e.key === 'ArrowLeft' && idx > 0) {
            e.preventDefault();
            boxes[idx - 1].focus();
        } else if (e.key === 'ArrowRight' && idx < boxes.length - 1) {
            e.preventDefault();
            boxes[idx + 1].focus();
        }
    }

    function onBoxBeforeInput(e) {
        if (!e.target.classList.contains('wordle-box')) return;
        const box = e.target;
        if (e.inputType === 'insertText' && box.value && e.data) {
            e.preventDefault();
            box.value = e.data.toUpperCase();
            const row = box.parentElement;
            const boxes = Array.from(row.querySelectorAll('.wordle-box'));
            const idx = boxes.indexOf(box);
            if (idx < boxes.length - 1) boxes[idx + 1].focus();
        }
    }

    function onBoxInput(e) {
        if (!e.target.classList.contains('wordle-box')) return;
        const box = e.target;
        box.value = box.value.toUpperCase();
        if (box.value && e.inputType === 'insertText') {
            const row = box.parentElement;
            const boxes = Array.from(row.querySelectorAll('.wordle-box'));
            const idx = boxes.indexOf(box);
            if (idx < boxes.length - 1) boxes[idx + 1].focus();
        }
    }

    /* =========================================
       SAVE & LOAD COMBINATIONS
       ========================================= */
    function openSaveModal() {
        gridHistory = [];
        resetGrid('#saveCombinationModal');
        
        const loadedId = document.getElementById('loadedCombinationId').value;
        if (loadedId) {
            const combos = JSON.parse(localStorage.getItem('savedCombinations')) || [];
            const combo = combos.find(c => c.id.toString() === loadedId);
            if (combo) populateGrid('#saveCombinationModal', combo);
        }
        
        document.getElementById('testWordInput').value = document.getElementById('mainTestWordInput').value;
        document.getElementById('saveCombinationModal').style.display = 'flex';
    }

    function closeSaveModal() {
        closeModal('saveCombinationModal');
        document.getElementById('combinationId').value = '';
    }

    function saveCombinationData() {
        const idInput = document.getElementById('combinationId').value;
        const testWord = document.getElementById('testWordInput').value;
        const rowsData = getGridData('#saveCombinationModal');
        // Use text for saving that preserves newlines
        const originalWords = getTextForSaving(activeInputElement);
        
        let combos = JSON.parse(localStorage.getItem('savedCombinations')) || [];

        const isGridEqual = (g1, g2) => JSON.stringify(g1) === JSON.stringify(g2);

        if (idInput) {
            const idx = combos.findIndex(c => c.id.toString() === idInput);
            if (idx > -1) {
                Object.assign(combos[idx], { rows: rowsData, testWord, originalWords });
                showMessage('Updated successfully!');
            }
        } else {
            const existingIdx = combos.findIndex(c => isGridEqual(c.rows, rowsData));
            if (existingIdx > -1) {
                const existing = combos[existingIdx];
                const mergedWords = [...new Set([...existing.originalWords.split('\n'), ...originalWords.split('\n')])].join('\n');
                existing.originalWords = mergedWords;
                if (testWord && !existing.testWord.includes(testWord)) existing.testWord += ` ${testWord}`;
                showMessage('Merged with existing combination!');
            } else {
                combos.push({ id: Date.now(), rows: rowsData, testWord, originalWords });
                showMessage('Saved new combination!');
            }
        }

        localStorage.setItem('savedCombinations', JSON.stringify(combos));
        closeSaveModal();
    }

    /* =========================================
       SEARCH & LOAD LOGIC
       ========================================= */
    function openSearchModal() {
        gridHistory = [];
        resetGrid('#searchModal');
        document.getElementById('searchModal').style.display = 'flex';
    }

    function openFirstMatchingCombination() {
        const searchData = getGridData('#searchModal');
        const combos = JSON.parse(localStorage.getItem('savedCombinations')) || [];

        const match = combos.find(combo => {
            return searchData.every((sRow, rIdx) => {
                return sRow.every((sBox, bIdx) => {
                    const savedBox = combo.rows[rIdx][bIdx];
                    const isEmpty = !sBox.letter && sBox.color === 'grey';
                    if (isEmpty) return true;
                    return (savedBox.letter === sBox.letter) && (savedBox.color === sBox.color);
                });
            });
        });

        if (match) loadCombinationToMainPage(match.id);
        else showMessage('No matching combination found.', 'error');
    }

    function loadCombinationToMainPage(id) {
        const combos = JSON.parse(localStorage.getItem('savedCombinations')) || [];
        const combo = combos.find(c => c.id.toString() === id.toString());
        if (!combo) return;

        // Convert newlines to BR tags for proper display in contenteditable
        const text = combo.originalWords || '';
        const htmlContent = text.split('\n').map(line => {
            return line || '<br>'; // Empty lines become <br>
        }).join('<br>');
        
        activeInputElement.innerHTML = htmlContent;
        document.getElementById('mainTestWordInput').value = combo.testWord;
        document.getElementById('loadedCombinationId').value = combo.id;
        
        handleWordInput();
        closeModal('searchModal');
        showMessage('Loaded successfully!');
    }

    function handleSavedListClick(e) {
        const id = e.target.dataset.id;
        if (!id) return;
        if (e.target.classList.contains('open-btn')) loadCombinationToMainPage(id);
        else if (e.target.classList.contains('delete-btn')) deleteCombination(id);
    }

    function deleteCombination(id) {
        openConfirmationModal('Delete this combination?', () => {
            let combos = JSON.parse(localStorage.getItem('savedCombinations')) || [];
            combos = combos.filter(c => c.id.toString() !== id.toString());
            localStorage.setItem('savedCombinations', JSON.stringify(combos));
            showMessage('Deleted.');
        });
    }

    function openConfirmationModal(msg, cb) {
        confirmCallback = cb;
        document.getElementById('confirmationMessage').textContent = msg;
        document.getElementById('confirmationModal').style.display = 'flex';
    }

    /* =========================================
       GRID HELPERS
       ========================================= */
    function resetGrid(modalId) {
        document.querySelectorAll(`${modalId} .wordle-box`).forEach(box => {
            box.value = '';
            box.dataset.color = 'grey';
            box.style.backgroundColor = '';
        });
    }

    function populateGrid(modalId, data) {
        const rows = document.querySelectorAll(`${modalId} .wordle-row`);
        rows.forEach((row, rIdx) => {
            const boxes = row.querySelectorAll('.wordle-box');
            boxes.forEach((box, bIdx) => {
                const cell = data.rows[rIdx][bIdx];
                box.value = cell.letter;
                box.dataset.color = cell.color;
            });
        });
        if (data.id) document.getElementById('combinationId').value = data.id;
    }

    function getGridData(modalId) {
        const rows = document.querySelectorAll(`${modalId} .wordle-row`);
        return Array.from(rows).map(row => {
            return Array.from(row.querySelectorAll('.wordle-box')).map(box => ({
                letter: box.value.toUpperCase(),
                color: box.dataset.color || 'grey'
            }));
        });
    }
  </script>
</body>
</html>
